<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title>dev etc : No parameters</title>
		<meta name="viewport" content="width=device-width">

		<link rel="alternate" type="application/rss+xml" title="dev etc" href="/feed.xml">

		<!-- syntax highlighting CSS -->
		<link rel="stylesheet" href="/css/syntax.css">

		<!-- Custom CSS -->
		<link rel="stylesheet" href="/css/main.css">
		<link rel="stylesheet" href="/css/quine.css">

		<!-- Footnotes -->
		<script src="/js/inline-footnotes.js"></script>

		<!-- Google Analytics -->
		<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-44839563-1', 'devetc.org');
		ga('send', 'pageview');
		</script>

	</head>
	<body>

		<header>
			<h1><a href="/">dev etc</a></h1>
			<div class="subtitle">Where mistakes go to die.</div>
		</header>

		<article>
	<h1>No parameters</h1>
	<div class="subtitle">Empty parentheses are not "no parameters" in (Objective-)C.</div>
	<div class="post-date">Published on Wednesday, 2015-10-14.</div>

	<div class="post">
	<p>In a lot of Objective-C code (and also some C), I have come across the misconception that <code>()</code> means “no parameters”. For example, I see code like:</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="kt">void</span> <span class="nf">thisCFunctionTakesNoParameters</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;Hello, world!&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">^</span><span class="n">plainCallback_t</span><span class="p">)();</span></code></pre></div>

<p>In fact just after block support was added, while still struggling with the syntax I discovered that the following compiled:</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">someMethod</span> <span class="p">{</span>
    <span class="bp">NSString</span> <span class="o">*</span><span class="p">(</span><span class="o">^</span><span class="n">iAmClever</span><span class="p">)()</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="n">foo</span><span class="p">,</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">bar</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">foo</span> <span class="nl">stringByAppendingString</span><span class="p">:</span><span class="n">bar</span><span class="p">];</span>
    <span class="p">};</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;joined: %@&quot;</span><span class="p">,</span> <span class="n">iAmClever</span><span class="p">(</span><span class="s">@&quot;John &quot;</span><span class="p">,</span> <span class="s">@&quot;Doe&quot;</span><span class="p">));</span>
<span class="p">}</span></code></pre></div>

<p>“Wow,” I thought, “I can shorten my syntax because it must infer the parameter types!” So I used this merrily, but then stuff went wrong and I learned the truth.</p>

<h1 id="reality">Reality</h1>

<p>Using <code>()</code> in a function type declaration means <strong>unspecified parameters</strong>.
This is a very old feature of C that has been maintained for backward compatibility. In fact, it was noted as an “obsolescent feature” in C89 — yes, that’s 1989!<sup id="fnref:fn-c89"><a href="#fn:fn-c89" class="footnote">1</a></sup></p>

<p>The use of function declarators with empty parentheses (not prototype-format parameter type declarators) is an obsolescent feature”.</p>

<p>Arguments passed to a function (or block) declared with <code>()</code> will use “default argument promotions”, which means they will not be the type declared by the block:</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)()</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="bp">NSInteger</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;arg = %ld&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="n">block</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span> <span class="c1">// arg = 42</span>

    <span class="n">block</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// arg = 4294967295</span>
    <span class="n">block</span><span class="p">((</span><span class="bp">NSInteger</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// arg = -1</span>

    <span class="bp">CGRect</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
    <span class="n">block</span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span><span class="p">);</span> <span class="c1">// arg = 4294984304</span>

    <span class="n">block</span><span class="p">(</span><span class="s">@&quot;fifteen&quot;</span><span class="p">);</span> <span class="c1">// arg = 4294984432</span>

    <span class="n">block</span><span class="p">();</span> <span class="c1">// arg = 4294984304</span>

    <span class="n">block</span><span class="p">(</span><span class="s">&quot;somewhere&quot;</span><span class="p">,</span> <span class="s">&quot;over&quot;</span><span class="p">,</span> <span class="s">&quot;the&quot;</span><span class="p">,</span> <span class="s">&quot;rainbow&quot;</span><span class="p">);</span> <span class="c1">// arg = 4294981825</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>The above compiles with no warnings whatsoever, even with <code>-Weverything</code>.
The warning that <em>should</em> catch this is <code>-Wstrict-prototypes</code>, but this doesn’t seem functional in clang (it’s <a href="https://gcc.gnu.org/onlinedocs/gcc-4.9.2/gcc/Warning-Options.html#index-Wstrict-prototypes-491">documented for GCC</a>).</p>

<p>Because this warning is apparently unimplemented, huge amounts of otherwise high quality code has these turds lurking in both public API and implementation:</p>

<ul>
  <li><a href="https://github.com/ReactiveCocoa/ReactiveCocoa/blob/e16f47cf9cb568136ebd81430b24af274c3c27c7/ReactiveCocoa/Objective-C/RACStream.h#L171">ReactiveCocoa</a> (e.g. <code>-[RACStream reduceEach:(id (^)())reduceBlock]</code>)</li>
  <li><a href="https://github.com/mixpanel/mixpanel-iphone/blob/bdd0f5a7f33ea0bfc4193f84ae2ed80258215bab/Mixpanel/Mixpanel.h#L559">Mixpanel</a> (e.g. <code>-[Mixpanel flushWithCompletion:(void (^)())handler]</code>)</li>
  <li><a href="https://github.com/facebook/facebook-ios-sdk/blob/61b636f61d67337d59741177289cdfe5ec0e5667/FBSDKCoreKit/FBSDKCoreKit/FBSDKGraphRequestConnection.m#L709">Facebook FBSDKCoreKit</a> (implementation only)</li>
  <li><a href="https://github.com/AFNetworking/AFNetworking/blob/fbd2bc8ac9353e6b9d2871b2a6a5cbc75b5ba841/AFNetworking/AFHTTPRequestOperation.m">AFNetworking</a> (implementation only)</li>
</ul>

<p>Even UIKit made this mistake!</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="bp">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span>
  <span class="nf">handleEventsForBackgroundURLSession:</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">identifier</span>
  <span class="nf">completionHandler:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)())</span><span class="nv">completionHandler</span></code></pre></div>

<p>The <code>completionHandler</code> block has since been marked <code>(void)</code> in the current <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIApplicationDelegate_Protocol/#//apple_ref/occ/intfm/UIApplicationDelegate/application:handleEventsForBackgroundURLSession:completionHandler:">online documentation</a>, but the headers in the iOS 9.0 SDK still show it as <code>()</code>.</p>

<h1 id="lets-fix-this">Let’s fix this!</h1>

<p>I have filed Radar 23116994 (view <a href="http://www.openradar.me/23116994">23116994 on Open Radar</a>). <a href="https://llvm.org/bugs/show_bug.cgi?id=20796">LLVM bug 20796</a> has been open since August 2014 but hadn’t moved. I’ve just commented on it, and have begun submitting pull requests to projects when I come across it (e.g. <a href="https://github.com/facebook/facebook-ios-sdk/pull/795">facebook-ios-sdk</a>).</p>

<p>You can start by searching your own code for <code>)()</code> and <code>() {</code> — not all results will be cases, and not all cases will be found by this but it’s a starting point.</p>

<div class="footnotes">
  <ol>
    <li id="fn:fn-c89">
      <p>From the <a href="http://port70.net/~nsz/c/c89/c89-draft.txt">C89 standard</a>: “3.9.4 Function declarators: <a href="#fnref:fn-c89" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

	</div>
</article>


		<footer>
			<p>dev etc is written by Jonathon Mah.</p>
			<ul class="contact">
				<li>me <span>AT</span> JonathonMah.com</li>
				<li><a href="https://github.com/jmah">github.com/jmah</a></li>
				<li><a href="https://twitter.com/dev_etc">twitter.com/dev_etc</a></li>
			</ul>
		</footer>

	</body>
</html>
